<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eGame - Audience Response</title>
    <link href="https://fonts.googleapis.com/css2?family=Pragati+Narrow&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Play:wght@700&display=swap" rel="stylesheet">

</head>
<style>
    * {font-family:'Pragati Narrow', sans-serif;color: #333;box-sizing: border-box;}
    #ecgPage{display: none;background-color: #f5f5f6;border-radius: 1vmax;}
    #title {color: #0f4c81;font-weight: 600;font-size: 3.5vmax;}
    #ecg {max-width:95%;max-height: 70vh;padding: 1vmax;}
    .row {display: flex;font-size: 1.9vmax;flex-wrap: wrap;}
    .head {font-size: 2vmax;font-weight: 700;padding-top: 1vmax;color: #c5f000;}
    .col3, .col4 {padding: 0.5vmax;margin: 0.1vmax;line-height: 140%;color: #f1f1f1;background-color: #0f4c81;}
    .col3 {flex:29%}
    .col4 {flex: 36%;}
    @media only screen and (max-width: 1000px) {
      .col3, .col4 {
        flex: 100%;}}
    .round {border: #aaa solid 0.1vmax;border-radius: 1vmax;}
    .cBx {margin-left: 0.2vmax;margin-right: 0.3vmax;width: 1.3vmax;height: 1.3vmax;}
    #miTable TH, #miTable TR, #miTable TD {color: #f1f1f1;
        border: #aaa solid 0.1vmax;font-size:1.8vmax;text-align: center;padding: 0;
        line-height: 110%;border-collapse: collapse;}
    #submitBut {text-align: center;font-size: 2vmax;cursor: pointer;display: none;}
    .butt {text-align: center;padding: 1vmax;font-size: 2vmax;vertical-align: baseline;}

    /*intro*/
    .lemon {color: #c5f000}
    .cursive {font-family: 'Audiowide', cursive;}
    #card {background-color: #0f4c81;width: 100%;line-height: 180%;display: block;
    text-align: center;padding: 2vmax 1vmax;z-index: -1;}
    #welcome {color: azure;font-size: 2.5vmax;padding:3vmax 1vmax;}
    #wait {color: azure;font-size: 2.5vmax;padding:1vmax;}


</style>

<body>

<!--ecg page-->
<div id="ecgPage">
    <div id="demo"></div>
<div style="text-align:center">
    <div id= 'title'></div>
    <img id="ecg">
</div>

<!--answer sheet-->
<div id="answerSheet" class="row">
    <div class="col3 round">
        
        <div class="head">
            1. General Features</div>
        <input class="cBx" label="1.1" id="1.1" type="checkbox">1.1 Normal ECG<br>
        <input class="cBx" label="1.2" id="1.2" type="checkbox">1.2 Normal variant<br>
        <input label="1.3" class="cBx" id="1.3" type="checkbox">1.3 Incorrect electrode placement<br>
        <input label="1.4" type="checkbox" id="1.4" class="cBx">1.4 Artifact
        <div class="head">
            2. P Wave</div>
        <input class="cBx" label="2.1" id="2.1" type="checkbox">2.1 RA abnormalities/enlargement<br>
        <input label="2.2" class="cBx" id="2.2" type="checkbox">2.2 LA abnormalities/enlargement
       
        <div class="head">
            3. RHYTHM - Atrial Rhythms</div>
        <input label="3.1" type="checkbox" id="3.1" class="cBx">3.1 Sinus rhythm<br>
        <input label="3.2" type="checkbox" id="3.2" class="cBx">3.2 Sinus arrhythmia<br>
        <input label="3.3" type="checkbox" id="3.3" class="cBx">3.3 Sinus bradycardia(&lt;60)<br>
        <input label="3.4" type="checkbox" id="3.4" class="cBx">3.4 Sinus tachycardia(&gt;100)<br>
        <input label="3.5" type="checkbox" id="3.5" class="cBx">3.5 Sinus pause or sinus arrest<br>
        <input label="3.6" type="checkbox" id="3.6" class="cBx">3.6 Sinoatrial exit block<br>
        <input label="3.7" type="checkbox" id="3.7" class="cBx">3.7 Atrial premature complexes<br>
        <input label="3.8" type="checkbox" id="3.8" class="cBx">3.8 Atrial tachycardia<br>
        <input label="3.9" type="checkbox" id="3.9" class="cBx">3.9 Atrial tachycardia, multifocal<br>
        <input label="3.10" type="checkbox" id="3.10" class="cBx">3.10 Atrial flutter<br>
        <input label="3.11" type="checkbox" id="3.11" class="cBx">3.11 Atrial fibrillation
        
        <div class="head">
            4. RHYTHM - AV Junctional Rhythms</div>
        <input label="4.1" type="checkbox" id="4.1" class="cBx">4.1 AV junctional premature complexes<br>
        <input label="4.2" type="checkbox" id="4.2" class="cBx">4.2 AV junctional escape complexes<br>
        <input label="4.3" type="checkbox" id="4.3" class="cBx">4.3 AV junctional rhythm/tachycardia
        
        <div class="head">
            5. RHYTHM - Ventricular Rhythms</div>
        <input label="5.1" type="checkbox" id="5.1" class="cBx">5.1 Ventricular premature complexes<br>
        <input label="5.2" type="checkbox" id="5.2" class="cBx">5.2 Ventricular parasystole<br>
        <input label="5.3" type="checkbox" id="5.3" class="cBx">5.3 Ventricular tachycardia (3 or more consecutive complexes)<br>
        <input label="5.4" type="checkbox" id="5.4" class="cBx">5.4 Accelerated idioventricular rhythm<br>
        <input label="5.5" type="checkbox" id="5.5" class="cBx">5.5 Ventricular escape complexes or rhythm<br>
        <input label="5.6" type="checkbox" id="5.6" class="cBx">5.6 Ventricular fibrillation
    </div>
    
    <div class="col3 round">
        
        <div class="head">
            6. AV Conduction</div>
        <input label="6.1" type="checkbox" id="6.1" class="cBx">6.1 AV Block, 1&deg;<br>
        <input label="6.2" type="checkbox" id="6.2" class="cBx">6.2 AV Block, 2&deg; - Mobitz I<br>
        <input label="6.3" type="checkbox" id="6.3" class="cBx">6.3 AV Block, 2&deg; - Mobitz II<br>
        <input label="6.4" type="checkbox" id="6.4" class="cBx">6.4 AV Block, 2:1<br>
        <input label="6.5" type="checkbox" id="6.5" class="cBx">6.5 AV Block, 3&deg;<br>
        <input label="6.6" type="checkbox" id="6.6" class="cBx">6.6 Wolff-Parkinson-White pattern<br>
        <input label="6.7" type="checkbox" id="6.7" class="cBx">6.7 AV dissociation

        <div class="head">
            7. Abnormal QRS voltage or axis</div>
        <input label="7.1" type="checkbox" id="7.1" class="cBx">7.1 Low voltage, limb leads<br>
        <input label="7.2" type="checkbox" id="7.2" class="cBx">7.2 Low voltage, precordial leads<br>
        <input label="7.3" type="checkbox" id="7.3" class="cBx">7.3 Left axis deviation(>-30&deg;)<br>
        <input label="7.4" type="checkbox" id="7.4" class="cBx">7.4 Right axis deviation(>+100&deg;)<br>
        <input label="7.5" type="checkbox" id="7.5" class="cBx">7.5 Electrical alternans

        <div class="head">
            8. Ventricular hypertrophy</div>
        <input label="8.1" type="checkbox" id="8.1" class="cBx">8.1 Left ventricular hypertrophy<br>
        <input label="8.2" type="checkbox" id="8.2" class="cBx">8.2 Right ventricular hypertrophy<br>
        <input label="8.3" type="checkbox" id="8.3" class="cBx">8.3 Combined ventricular hypertrophy

        <div class="head">
            9. Clinical disorder</div>
        <input label="9.1" type="checkbox" id="9.1" class="cBx">9.1 Brugada syndrome<br>
        <input label="9.2" type="checkbox" id="9.2" class="cBx">9.2 Digitalis toxicity<br>
        <input label="9.3" type="checkbox" id="9.3" class="cBx">9.3 Torsades de Pointes<br>
        <input label="9.4" type="checkbox" id="9.4" class="cBx">9.4 Hyperkalemia<br>
        <input label="9.5" type="checkbox" id="9.5" class="cBx">9.5 Hypokalemia<br>
        <input label="9.6" type="checkbox" id="9.6" class="cBx">9.6 Hypercalcemia<br>
        <input label="9.7" type="checkbox" id="9.7" class="cBx">9.7 Hypocalcemia<br>
        <input label="9.8" type="checkbox" id="9.8" class="cBx">9.8 Dextrocardia, mirror image<br>
        <input label="9.9" type="checkbox" id="9.9" class="cBx">9.9 Acute cor pulmonale including pulmonary embolism<br>
        <input label="9.10" type="checkbox" id="9.10" class="cBx">9.10 Pericardial effusion<br>
        <input label="9.11" type="checkbox" id="9.11" class="cBx">9.11 Acute pericarditis<br>
        <input label="9.12" type="checkbox" id="9.12" class="cBx">9.12 Hypertrophic cardiomyopathy<br>
        <input label="9.13" type="checkbox" id="9.13" class="cBx">9.13 Central nervous system disorder<br>
        <input label="9.14" type="checkbox" id="9.14" class="cBx">9.14 Hypothermia

    </div>
    <div class="col4 round">
        <div class="head">
            10. Intraventricular Conduction</div>
        <input label="10.1" type="checkbox" id="10.1" class="cBx">10.1 RBBB, complete<br>
        <input label="10.2" type="checkbox" id="10.2" class="cBx">10.2 RBBB, incomplete<br>
        <input label="10.3" type="checkbox" id="10.3" class="cBx">10.3 Left anterior fascicular block<br>
        <input label="10.4" type="checkbox" id="10.4" class="cBx">10.4 Left posterior fascicular block<br>
        <input label="10.5" type="checkbox" id="10.5" class="cBx">10.5 LBBB, complete<br>
        <input label="10.6" type="checkbox" id="10.6" class="cBx">10.6 LBBB, incomplete<br>
        <input label="10.7" type="checkbox" id="10.7" class="cBx">10.7 Aberrant conduction (including rate related)<br>
        <input label="10.8" type="checkbox" id="10.8" class="cBx">10.8 Intraventricular conduction disturbance, non-specified type

        <div class="head">
            11. Myocardial Infarction</div>
            <table id="miTable">
                <tr>
                    <th></th>
                    <th>Age recent, or probably acute</th>
                    <th>Age indeterminate, or probably old</th>
                </tr>
                <tr>
                    <td>Anterolateral</td>
                    <td>
                        <input label="11.1" type="checkbox" id="11.1" class="cBx">11.1 
                    </td>
                    <td>
                        <input label="11.2" type="checkbox" id="11.2" class="cBx">11.2 
                    </td>
                </tr>
                <tr>
                    <td>Anterior or anteroseptal</td>
                    <td>
                        <input label="11.3" type="checkbox" id="11.3" class="cBx">11.3 
                    </td>
                    <td>
                        <input label="11.4" type="checkbox" id="11.4" class="cBx">11.4 
                    </td>
                </tr>
                <tr>
                    <td>Lateral</td>
                    <td>
                        <input label="11.5" type="checkbox" id="11.5" class="cBx">11.5 
                    </td>
                    <td>
                        <input label="11.6" type="checkbox" id="11.6" class="cBx">11.6 
                    </td>
                </tr>
                <tr>
                    <td>Inferior</td>
                    <td>
                        <input label="11.7" type="checkbox" id="11.7" class="cBx">11.7
                    </td>
                    <td>
                        <input label="11.8" type="checkbox" id="11.8" class="cBx">11.8 
                    </td>
                </tr>
                <tr>
                    <td>Posterior</td>
                    <td>
                        <input label="11.9" type="checkbox" id="11.9" class="cBx">11.9
                    </td>
                    <td>
                        <input label="11.10" type="checkbox" id="11.10" class="cBx">11.10 
                    </td>
                </tr>
            </table>

        <div class="head">
            12. ST-T U Abnormalities</div>
        <input label="12.1" type="checkbox" id="12.1" class="cBx">12.1 Normal variant, early repolarization<br>
        <input label="12.2" type="checkbox" id="12.2" class="cBx">12.2 Normal variant, juvenile T waves<br>
        <input label="12.3" type="checkbox" id="12.3" class="cBx">12.3 Non-specific ST and/or T wave abnormalities<br>
        <input label="12.4" type="checkbox" id="12.4" class="cBx">12.4 ST and/or T wave abnormalities suggesting myocardial ischemia<br>
        <input label="12.5" type="checkbox" id="12.5" class="cBx">12.5 ST and/or T wave abnormalities suggesting myocardial injury<br>
        <input label="12.6" type="checkbox" id="12.6" class="cBx">12.6 ST and/or T wave abnormalities suggesting electrolyte disturbances<br>
        <input label="12.7" type="checkbox" id="12.7" class="cBx">12.7 ST and/or T wave abnormalities secondary to hypertrophy<br>
        <input label="12.8" type="checkbox" id="12.8" class="cBx">12.8 Prolonged Q-T interval<br>
        <input label="12.9" type="checkbox" id="12.9" class="cBx">12.9 Prominent U waves

        <div class="head">
            13. Pacemaker Function</div>
        <input type="checkbox" id="13.1" class="cBx">13.1 Atrial or coronary sinus pacing<br>
        <input type="checkbox" id="13.2" class="cBx">13.2 Ventricular demand pacemaker (VVI), normally functioning<br>
        <input type="checkbox" id="13.3" class="cBx">13.3 Dual-chamber pacemaker (DDD), normally functioning<br>
        <input type="checkbox" id="13.4" class="cBx">13.4 Pacemaker malfunction, not constantly capturing (atrium or ventricle)<br>
        <input type="checkbox" id="13.5" class="cBx">13.5 Pacemaker malfunction, not constantly sensing (atrium or ventricle)<br>
        <input type="checkbox" id="13.6" class="cBx">13.6 Paced morphology consistent with biventricular pacing or CRT<br>
    </div>
</div>

    <!--submit-->
    <form id="audScore" 
    name="audienceScore" 
    method="POST" 
    data-netlify="true">

        <div id="nameInput" class="butt">
            <label for="audienceName">Your Name is
            <input type="text" id="audName" name="audName"></label>
        </div>
        <input id="oldName" type="text" name="oldName" style="display:none">
        <input id="qNo" type="number" name="qNo" style="display:none">
        <div class="butt" id="submitInput">
            <input id="totalScore" type="number" name="audienceTotalScore" 
            style="display:none">
            <input type="submit" value="Submit" id="submitBut">
        </div>
    </form>
</div>

<!--top and foot-->

<!--intro page-->
<div id="card" class="round bgGd">
    <img src="ccLogoLemon.png" style="width:3vmax;text-align: center;padding-top: 10vmax;">
    <div class="lemon cursive" style="font-size:3vmax;text-align: center;">
    CC2023
    <br><img src="xLemon.png" style="width:2vmax;text-align: center;">
    <br>ElectroCardioGame</div><br>
    <div id="welcome">
        Thanks for joining us.<br>
        Please wait here. The game will begin shortly.
    </div>
    <div id="wait"></div>
    <div style="font-size:1.6vmax;color: #022645">
    property of heartRhythmBox.com
    </div>
</div>
<!--button id="next" onclick="next()">Next</button-->


<script>

//aGd();
setInterval(() => {
    fetchQ();    
}, 5000);


//global var
var totalQ = 12
    var qNo = -1;
    var q2Vote = [4,8,12];
    var score = 0;
    var nameEntered = 'Anonymous';
    var keyJson = [{"no":0, "key": '1.2', "score": 0},
                {"no":0, "key": '2.1', "score": 0},
                {"no":0, "key": '2.2', "score": 0},
                {"no":0, "key": '3.1', "score": 0},
                {"no":4, "key": '1.1', "score": 2},
                {"no":4, "key": '1.2', "score": 5},
                {"no":4, "key": '1.3', "score": 3},         
                {"no":8, "key": '2.1', "score": 3},
                {"no":8, "key": '2.2', "score": 4},
                {"no":8, "key": '2.3', "score": 3},   
                {"no":12, "key": '3.1', "score": 5},
                {"no":12, "key": '3.2', "score": 2},
                {"no":12, "key": '3.3', "score": 3}]
    var showForm;

//fetch
function fetchQ(){
    const options = {
  method: 'GET',
  headers: {
    accept: 'application/json',
    Authorization: 'Bearer Tp5sLcLZPjW95uAWeBWFgJmKZ2PtfQSIb6-IwB_NCuQ'
    }
    };

    fetch('https://api.netlify.com/api/v1/forms/634e14b8e3483f0008fc0ab2/submissions', options)
    .then(response => response.json())
    .then(result =>sortFeed(result))
    .catch(err => console.error(err));

    function sortFeed(result){
        var feedArray = []
        for (let index = 0; index < result.length; index++) {
            qSent = result[index].data.q2Send;
            tSent = result[index].data.t2Send
            toPush = [qSent,tSent]
            feedArray.push(toPush)
            //console.log (feedArray)
        }

        sortA = feedArray.sort(function(a,b){
            if (a[1]>b[1]) {return -1}
        })
        //console.log(sortA)
        newQ = sortA[0][0]
        //console.log(newQ)
        if (newQ!=qNo){
            qNo=newQ;
            if (qNo==9){
                afterSubmit()
            } else (ecgLoad())
            
        }
    }
  
}


//submit
const handleSubmit = (event) => {
    thisScore = calcScore();  
    score = score + thisScore;  
    if (qNo==4)
        {nameEntered = document.getElementById('audName').value;}
    document.getElementById('oldName').value = nameEntered;

    document.getElementById('totalScore').value = score;
    document.getElementById('qNo').value = qNo;
    
    event.preventDefault();
    const myForm = event.target;
    const formData = new FormData(myForm);
    

  fetch("/", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams(formData).toString(),
  })
    .then(() => console.log("the form is submitted successfully"))
    .catch((error) => alert(error));
    afterSubmit(); 
};


document
    .querySelector("form")
    .addEventListener("submit", handleSubmit);

//end submit
 
function ecgLoad(){
    //document.getElementById('next').innerHTML = nameEntered;
    document.getElementById('ecgPage').style.display = 'block'
    document.getElementById('card').style.display = 'none'
    aGd(0)
    displayName();
    sButt = document.getElementById('submitBut')
    form = document.getElementById('audScore')
    aSheet = document.getElementById('answerSheet')

    //clear answersheet
    var input = document.getElementsByClassName('cBx')
    for (let index = 0; index < input.length; index++) {
        input[index].checked = false;
    }

    var vote=0;
    for (let index = 0; index < q2Vote.length; index++) {
        if (qNo==q2Vote[index]){
            vote = 1;
        }
    }
    if (qNo==0)
        {aSheet.style.display = 'flex';
        form.style.display = 'none';
        }
    else if (vote==1){
        form.style.display = 'block';
        sButt.style.display = 'inline-block'
        aSheet.style.display = 'flex'

        if (qNo>q2Vote[0]){
            document.getElementById('audName').style.display = 'none'
            document.getElementById('nameInput').innerHTML = 
            'Your Name is: '+ nameEntered 
        }
        }
        else {
            aSheet.style.display = 'none'
            form.style.display = 'none'
        }
   
}

function afterSubmit(){
    thisScore = calcScore();
    document.getElementById('card').style.display = 'block'
    document.getElementById('answerSheet').style.display = 'none'
    document.getElementById('audScore').style.display = 'none'

    document.getElementById('welcome').innerHTML = nameEntered + ', thanks for joining the vote' + '<br />' + 
    'You got ' + thisScore + ' from this question.' + '<br />' +
    'Your total score is '+ score + '<br />' 
    
    if (qNo==12){document.getElementById('wait').innerHTML 
    = 'That was the last question.' + '<br />' +
    'We hope you enjoyed/learned from us.' + '<br />' +
    'See you next year.'+'<br />'
    }
    else (document.getElementById('wait').innerHTML = 'Please wait here for the next question.')
}

function calcScore(){
    var input = document.getElementsByClassName('cBx')

    //get answer array
    const answer = []
    for (let index = 0; index < input.length; index++) {
        if (input[index].checked){
            const item = input[index].id
            answer.push(item)
        }
    }

    //get key and score
    const key = [];const kScore = []
    for (let index = 0; index < keyJson.length; index++) {
        if (keyJson[index].no==qNo){
            key.push(keyJson[index].key)
            kScore.push(keyJson[index].score)
        }
    }

    var thisScore = 0;
    answer.forEach(function(item){
        for (let index = 0; index < key.length; index++) {
            if (item == key[index]){
                thisScore = thisScore + (kScore[index])    
            }
        }
    })
    //document.getElementById('demo').innerHTML = thisScore;
    return thisScore;
}

function displayName(){
    document.getElementById('title').innerHTML = "Question No. " + qNo + " /" + totalQ;
    var source = "ecgs//ecg"+ qNo.toString()+".png";
    document.getElementById('ecg').src = source;
}

function aGd(off){
    var g = document.getElementsByClassName('bgGd');
    //#0f817d, #1774c6, #0f1381, #0f4c81
    //background-image: radial-gradient(farthest-side at 70% 35%, #FDE570, #FAE25F, #FACF1A,#F0BC18)
    var x =0; var y = Math.floor((Math.random() * 100) + 1);
    var inc = true;
    if (off==0) {clearInterval(id)}
    else {
    var id = setInterval(color, 50);

    function color(){
        if (inc){
            if (x==100){
                inc = false;
                //yDelta= Math.floor((Math.random() * 70) + 1);y = y-yDelta;
                x--;y--;
            } else {x++;}
        } else {
            if (x==0){
                inc = true;
                //yDelta= Math.floor((Math.random() * 70) + 1);y= y+yDelta;
                x++;y++;
            } else {x--;}
        }
    if (y<0 || y>100){y=Math.floor((Math.random() * 100) + 1)}
    g[0].style.backgroundImage = "radial-gradient(farthest-side at " + x +"%" + y + "%,#218ae5,#1774c6, #0f4c81,#0f1381,#0a3153)"
    }}
}




</script>
</body>
</html>