<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eGame - Audience Response</title>
    <link rel="icon" href="box coral.png" type="image/png" sizes="60x60">
    <meta name="author" content="t'Thon">
    <link href="https://fonts.googleapis.com/css2?family=Pragati+Narrow&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Play:wght@700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/2c3e1e841c.js" crossorigin="anonymous"></script>

</head>
<style>
    * {font-family:'Pragati Narrow', sans-serif;color: #333;box-sizing: border-box;}
    #ecgPage{text-align:center;display: block;max-height: 100vh;overflow: hidden;}
    #workSheet {display:flex;max-height: 92vh;flex-wrap: wrap;background-color: #f5f5f6;border-radius: 1vmax;}
    #title {color: #0f4c81;font-weight: 600;font-size: 3.5vmax;text-align: center;}
    #ecg {max-width:99%;max-height: 90vh;padding: 0.1vmax;text-align: center;
        margin-left: auto;margin-right: auto;background-color: #f5f5f6;}
    #ecgArea {text-align:center;width: 75%;background-color: #f5f5f6;border-radius: 1vmax;}
    #answerSheet {width: 25%;overflow-y: scroll;direction: rtl;max-height: 92vh;border-radius: 1vmax;
        background-color: #f5f5f6;font-size: 1.9vmax;text-align: left;}
    
    /*scrollbar*/
    #answerSheet::-webkit-scrollbar {-webkit-appearance: none;}
    #answerSheet::-webkit-scrollbar:vertical {width: 11px;}
    #answerSheet::-webkit-scrollbar-thumb {border-radius: 8px;
    border: 2px solid white; 
    background-color: rgba(0, 0, 0, .5);}

    .head {font-size: 2vmax;font-weight: 700;padding-top: 1vmax;color: #c5f000;}
    .col {padding: 0.5vmax;color: #f1f1f1;background-color: #0f4c81;direction: ltr;line-height: 140%;}
    .col label {color: #f1f1f1;}
    .round {border: #aaa solid 0.1vmax;border-radius: 1vmax;}
    .cBx {margin-left: 0.2vmax;margin-right: 0.3vmax;width: 1.3vmax;height: 1.3vmax;}
    #miTable TH, #miTable TR, #miTable TD {color: #f1f1f1;
        border: #aaa solid 0.1vmax;font-size:1.8vmax;text-align: center;padding: 0;
        border-collapse: collapse;}
    #audScore {background-color:#f5f5f6;border-radius: 1vmax;}
    #submitBut {text-align: center;font-size: 2vmax;cursor: pointer;display: inline-block;}
    .butt {text-align: center;padding: 1vmax;font-size: 2vmax;vertical-align: baseline;}
    #fakeButt {display: none;}

    /*orientation bar*/
    #oBar{position: fixed;left:1%;top:1%;text-align: left;padding: 0.5vmax;cursor: pointer;}
    #aRight{display: none;}
    #aBottom {display: inline-block;}

    /*responsive*/
    @media screen and (min-width:801px) and (max-width: 1100px){
        #ecgArea {width: 100%;}
        #answerSheet {width: 100%;display: flex;direction: ltr;max-height: 50vh;overflow-y: scroll;}
                /*scrollbar*/
            #answerSheet::-webkit-scrollbar {-webkit-appearance: none;}
            #answerSheet::-webkit-scrollbar:vertical {width: 11px;}
            #answerSheet::-webkit-scrollbar-thumb {border-radius: 8px;
            border: 2px solid white; 
            background-color: rgba(0, 0, 0, .5);}
        
        .head {font-size: 18px;}
        .col {height: fit-content;font-size: 18px;}
        #miTable TH, #miTable TR, #miTable TD {font-size: 18px;}
    
        .col:first-of-type {flex: 29%;} 
        .col:nth-of-type(2) {flex: 29%;}
        .col:nth-of-type(3) {flex: 36%;}
        #obar, #aDown, #aRight, #aBottom {display: none;}
        
    }

    @media screen and (max-width:800px){
        #ecgArea {width: 100%;}
        #answerSheet {width: 100%;display: flex;direction: ltr;max-height: 60vh;
            flex-wrap: wrap;padding: 1vmax;font-size: 18px;}
            
            /*scrollbar*/
            #answerSheet::-webkit-scrollbar {-webkit-appearance: none;}
            #answerSheet::-webkit-scrollbar:vertical {width: 11px;}
            #answerSheet::-webkit-scrollbar-thumb {border-radius: 8px;
            border: 2px solid white; 
            background-color: rgba(0, 0, 0, .5);}
        .head {font-size: 18px;}
        .col {height: fit-content;font-size: 18px;padding-left: 1vmax;}
        .col {flex: 100%;}
        #miTable TH, #miTable TR, #miTable TD {font-size: 18px;padding: 0.5vw;}
        #obar, #aDown, #aRight, #aBottom  {display: none;}
    }

    /*intro*/
    .lemon {color: #c5f000}
    .cursive {font-family: 'Audiowide', cursive;}
    /*card display has to be 'block'*/
    #card {background-color: #0f4c81;width: 100%;height: 100%;
        line-height: 180%;position: absolute;top: 0;left: 0;z-index: 1;
        display: block;text-align: center;padding: 2vmax 1vmax;}
    #welcome {color: azure;font-size: 2.5vmax;padding:3vmax 1vmax;line-height: 120%;}
    #wait {color: azure;font-size: 2.5vmax;}
    #foot {display: none;background-color:#efefef;text-align:center;color: #888;
        padding-bottom: 5vmax;padding-top: 8vmax;border-radius: 1vmax;
        width: 100%;}
    #preLoad {opacity: 1.0;width: 0.1px;height: 0.1px;}   
    
    /*animate logo*/
    @keyframes animateInvert {
        0% {filter: none}
        40% {filter: invert(100%)}
        100% {filter: none}
    }

</style>

<body>
<!--ecg page-->
<div id="ecgPage">
    <div id="workSheet">
        <div id="ecgArea">
            <div id= 'title'></div>
            <img id="ecg">
            <img id="preLoad">
        </div>
    
    <!--answer sheet-->
        <div id="answerSheet" onscroll="arrow('off')">
            <div class="col round">
                
                <!--div class="head">
                    1. General Features</div-->
                <!--input class="cBx" id="1.1" type="checkbox"><label for="1.1">1.1 Normal ECG</label><br>
                <input class="cBx" id="1.2" type="checkbox"><label for="1.2">1.2 Normal variant</label><br>
                <input class="cBx" id="1.3" type="checkbox"><label for="1.3">1.3 Incorrect electrode placement</label><br>
                <input type="checkbox" id="1.4" class="cBx"><label for="1.4">1.4 Artifact</label-->
                <!--div class="head">
                    2. P Wave</div>
                <input class="cBx" id="2.1" type="checkbox"><label for="2.1">2.1 RA abnormalities/enlargement</label><br>
                <input class="cBx" id="2.2" type="checkbox"><label for="2.2">2.2 LA abnormalities/enlargement</label-->
            
                <div class="head">
                    1. RHYTHM - Atrial Rhythms</div>
                <input type="checkbox" id="1.1" class="cBx"><label for="1.1">1.1 Sinus rhythm</label><br>
                <!--input type="checkbox" id="3.2" class="cBx"><label for="3.2">3.2 Sinus arrhythmia</label><br-->
                <input type="checkbox" id="1.2" class="cBx"><label for="1.2">1.2 Sinus bradycardia(&lt;60)</label><br>
                <input type="checkbox" id="1.3" class="cBx"><label for="1.3">1.3 Sinus tachycardia(&gt;100)</label><br>
                <!--input type="checkbox" id="3.5" class="cBx"><label for="3.5">3.5 Sinus pause or sinus arrest</label><br>
                <input type="checkbox" id="3.6" class="cBx"><label for="3.6">3.6 Sinoatrial exit block</label><br-->
                <input type="checkbox" id="1.4" class="cBx"><label for="1.4">1.4 Atrial premature complexes</label><br>
                <input type="checkbox" id="1.5" class="cBx"><label for="1.5">1.5 Atrial tachycardia</label><br>
                <input type="checkbox" id="1.6" class="cBx"><label for="1.6">1.6 Supraventricular tachycardia</label><br>
                <!--input type="checkbox" id="3.9" class="cBx"><label for="3.9">3.9 Atrial tachycardia, multifocal</label><br>
                <input type="checkbox" id="3.10" class="cBx"><label for="3.10">3.10 Atrial flutter</label><br-->
                <input type="checkbox" id="1.7" class="cBx"><label for="1.7">1.7 Atrial fibrillation</label>
                
                <!--div class="head">
                    4. RHYTHM - AV Junctional Rhythms</div>
                <input type="checkbox" id="4.1" class="cBx"><label for="4.1">4.1 AV junctional premature complexes</label><br>
                <input type="checkbox" id="4.2" class="cBx"><label for="4.2">4.2 AV junctional escape complexes</label><br>
                <input type="checkbox" id="4.3" class="cBx"><label for="4.3">4.3 AV junctional rhythm/tachycardia</label-->
                
                <div class="head">
                    2. RHYTHM - Ventricular Rhythms</div>
                <input type="checkbox" id="2.1" class="cBx"><label for="2.1">2.1 Ventricular premature complexes</label><br>
                <!--input type="checkbox" id="5.2" class="cBx"><label for="5.2">5.2 Ventricular parasystole</label><br-->
                <input type="checkbox" id="2.2" class="cBx"><label for="2.2">2.2 Ventricular tachycardia (3 or more consecutive complexes)</label><br>
                <!--input type="checkbox" id="5.4" class="cBx"><label for="5.4">5.4 Accelerated idioventricular rhythm</label><br>
                <input type="checkbox" id="5.5" class="cBx"><label for="5.5">5.5 Ventricular escape complexes or rhythm</label><br>
                <input type="checkbox" id="5.6" class="cBx"><label for="5.6">5.6 Ventricular fibrillation</label-->
        
                
                <div class="head">
                    3. AV Conduction</div>
                <input type="checkbox" id="3.1" class="cBx"><label for="3.1">3.1 AV Block, 1&deg;</label><br>
                <input type="checkbox" id="3.2" class="cBx"><label for="3.2">3.2 AV Block, 2&deg; - Mobitz I</label><br>
                <input type="checkbox" id="3.3" class="cBx"><label for="3.3">3.3 AV Block, 2&deg; - Mobitz II</label><br>
                <input type="checkbox" id="3.4" class="cBx"><label for="3.4">3.4 AV Block, 2:1</label><br>
                <input type="checkbox" id="3.5" class="cBx"><label for="3.5">3.5 AV Block, 3&deg;</label><br>
                <input type="checkbox" id="3.6" class="cBx"><label for="3.6">3.6 Wolff-Parkinson-White pattern</label><br>
                <input type="checkbox" id="3.7" class="cBx"><label for="3.7">3.7 AV dissociation</label><br>
                <input type="checkbox" id="3.8" class="cBx"><label for="3.8">3.8 Aberrant conduction</label>
    
            </div>
            <div class="col round">
                <div class="head">
                    4. Abnormal axis</div>
                <!--input type="checkbox" id="7.1" class="cBx"><label for="7.1">7.1 Low voltage, limb leads</label><br>
                <input type="checkbox" id="7.2" class="cBx"><label for="7.2">7.2 Low voltage, precordial leads</label><br-->
                <input type="checkbox" id="4.1" class="cBx"><label for="4.1">4.1 Left axis deviation(>-30&deg;)</label><br>
                <input type="checkbox" id="4.2" class="cBx"><label for="4.2">4.2 Right axis deviation(>+100&deg;)</label><br>
                <!--input type="checkbox" id="7.5" class="cBx"><label for="7.5">7.5 Electrical alternans</label-->
    
                <!--div class="head">
                    8. Ventricular hypertrophy</div>
                <input type="checkbox" id="8.1" class="cBx"><label for="8.1">8.1 Left ventricular hypertrophy</label><br>
                <input type="checkbox" id="8.2" class="cBx"><label for="8.2">8.2 Right ventricular hypertrophy</label><br>
                <input type="checkbox" id="8.3" class="cBx"><label for="8.3">8.3 Combined ventricular hypertrophy</label-->
    
                <div class="head">
                    5. Clinical disorder</div>
                <input type="checkbox" id="5.1" class="cBx"><label for="5.1">5.1 Brugada syndrome</label><br>
                <input type="checkbox" id="5.2" class="cBx"><label for="5.2">5.2 Digitalis toxicity</label><br>
                <!--input type="checkbox" id="9.3" class="cBx"><label for="9.3">9.3 Torsades de Pointes</label><br-->
                <!--input type="checkbox" id="9.5" class="cBx"><label for="9.5">9.5 Hypokalemia</label><br>
                <input type="checkbox" id="9.6" class="cBx"><label for="9.6">9.6 Hypercalcemia</label><br>
                <input type="checkbox" id="9.7" class="cBx"><label for="9.7">9.7 Hypocalcemia</label><br>
                <input type="checkbox" id="9.8" class="cBx"><label for="9.8">9.8 Dextrocardia, mirror image</label><br-->
                <input type="checkbox" id="5.3" class="cBx"><label for="5.3">5.3 Acute cor pulmonale including pulmonary embolism</label><br>
                <!--input type="checkbox" id="9.10" class="cBx"><label for="9.10">9.10 Pericardial effusion</label><br-->
                <input type="checkbox" id="5.4" class="cBx"><label for="5.4">5.4 Acute pericarditis</label><br>
                <!--input type="checkbox" id="9.12" class="cBx"><label for="9.12">9.12 Hypertrophic cardiomyopathy</label><br-->
                <input type="checkbox" id="5.5" class="cBx"><label for="5.5">5.5 Central nervous system disorder</label><br>
                <input type="checkbox" id="5.6" class="cBx"><label for="5.6">5.6 Hyperkalemia</label>
                <!--input type="checkbox" id="9.14" class="cBx"><label for="9.14">9.14 Hypothermia</label-->
    
            </div>
            <div class="col round">
                <!--div class="head">
                    10. Intraventricular Conduction</div>
                <input type="checkbox" id="10.1" class="cBx"><label for="10.1">10.1 RBBB, complete</label><br>
                <input type="checkbox" id="10.2" class="cBx"><label for="10.2">10.2 RBBB, incomplete</label><br>
                <input type="checkbox" id="10.3" class="cBx"><label for="10.3">10.3 Left anterior fascicular block</label><br>
                <input type="checkbox" id="10.4" class="cBx"><label for="10.4">10.4 Left posterior fascicular block</label><br>
                <input type="checkbox" id="10.5" class="cBx"><label for="10.5">10.5 LBBB, complete</label><br>
                <input type="checkbox" id="10.6" class="cBx"><label for="10.6">10.6 LBBB, incomplete</label><br>
                <input type="checkbox" id="10.7" class="cBx"><label for="10.7">10.7 Aberrant conduction (including rate related)</label><br>
                <input type="checkbox" id="10.8" class="cBx"><label for="10.8">10.8 Intraventricular conduction disturbance, non-specified type</label-->
    
                <div class="head">
                    6. Myocardial Infarction</div>
                    <table id="miTable">
                        <tr>
                            <th></th>
                            <th>Age recent, or probably acute</th>
                            <th>Age indeterminate, or probably old</th>
                        </tr>
                        <tr>
                            <td>Anterolateral</td>
                            
                            <td>
                                <input type="checkbox" id="6.1" class="cBx">
                                <label for="6.1">6.1</label>
                            </td>
                            <td>
                                <input type="checkbox" id="6.2" class="cBx">
                                <label for="6.2">6.2</label> 
                            </td>
                        </tr>
                        <tr>
                            <td>Anterior or anteroseptal</td>
                            <td>
                                <input type="checkbox" id="6.3" class="cBx">
                                <label for="6.3">6.3</label>
                            </td>
                            <td>
                                <input type="checkbox" id="6.4" class="cBx">
                                <label for="6.4">6.4</label> 
                            </td>
                        </tr>
                        <tr>
                            <td>Lateral</td>
                            <td>
                                <input type="checkbox" id="6.5" class="cBx">
                                <label for="6.5">6.5</label>
                            </td>
                            <td>
                                <input type="checkbox" id="6.6" class="cBx">
                                <label for="6.6">6.6</label>
                            </td>
                        </tr>
                        <tr>
                            <td>Inferior</td>
                            <td>
                                <input type="checkbox" id="6.7" class="cBx">
                                <label for="6.7">6.7</label>
                            </td>
                            <td>
                                <input type="checkbox" id="6.8" class="cBx">
                                <label for="6.8">6.8</label> 
                            </td>
                        </tr>
                        <tr>
                            <td>Posterior</td>
                            <td>
                                <input type="checkbox" id="6.9" class="cBx">
                                <label for="6.9">6.9</label>
                            </td>
                            <td>
                                <input type="checkbox" id="6.10" class="cBx">
                                <label for="6.10">6.10</label>
                            </td>
                        </tr>
                    </table>
    
                <div class="head">
                    7. ST-T Abnormalities</div>
                <!--input type="checkbox" id="12.1" class="cBx"><label for="12.1">12.1 Normal variant, early repolarization</label><br>
                <input type="checkbox" id="12.2" class="cBx"><label for="12.2">12.2 Normal variant, juvenile T waves</label><br>
                <input type="checkbox" id="12.3" class="cBx"><label for="12.3">12.3 Non-specific ST and/or T wave abnormalities</label><br>
                <input type="checkbox" id="12.4" class="cBx"><label for="12.4">12.4 ST and/or T wave abnormalities suggesting myocardial ischemia</label><br>
                <input type="checkbox" id="12.5" class="cBx"><label for="12.5">12.5 ST and/or T wave abnormalities suggesting myocardial injury</label><br-->
                <input type="checkbox" id="7.1" class="cBx"><label for="7.1">7.1 ST and/or T wave abnormalities suggesting electrolyte disturbances</label><br>
                <input type="checkbox" id="7.2" class="cBx"><label for="7.2">7.2 ST and/or T wave abnormalities secondary to hypertrophy</label><br>
                <input type="checkbox" id="7.3" class="cBx"><label for="7.3">7.3 Prolonged Q-T interval</label><br>
                <!--input type="checkbox" id="12.9" class="cBx"><label for="12.9">12.9 Prominent U waves</label-->
    
                <!--div class="head">
                    13. Pacemaker Function</div>
                <input type="checkbox" id="13.1" class="cBx"><label for="13.1">13.1 Atrial or coronary sinus pacing</label><br>
                <input type="checkbox" id="13.2" class="cBx"><label for="13.2">13.2 Ventricular demand pacemaker (VVI), normally functioning</label><br>
                <input type="checkbox" id="13.3" class="cBx"><label for="13.3">13.3 Dual-chamber pacemaker (DDD), normally functioning</label><br>
                <input type="checkbox" id="13.4" class="cBx"><label for="13.4">13.4 Pacemaker malfunction, not constantly capturing (atrium or ventricle)</label><br>
                <input type="checkbox" id="13.5" class="cBx"><label for="13.5">13.5 Pacemaker malfunction, not constantly sensing (atrium or ventricle)</label><br>
                <input type="checkbox" id="13.6" class="cBx"><label for="13.6">13.6 Paced morphology consistent with biventricular pacing or CRT</label><br-->
                </div>
        </div>
    
    <!--form-->
    <!--submit-->
    <form id="audScore" 
    name="audienceScore" 
    style="padding-bottom:2vmax;padding-top: 2vmax;width: 100%;">
    
        <div id="nameInput" class="butt">
            <label for="audienceName">Your Name is
            <input type="text" id="audName" name="audName"></label>
        </div>
        <input id="oldName" type="text" name="oldName" style="display:none">
        <input id="qNow" type="number" name="qNow" style="display:none">
        <div class="butt" id="submitInput">
            <input id="totalScore" type="number" name="audienceTotalScore" 
            style="display:none">
            <input value="Submit" id="submitBut" onclick="handleSubmit()"
            class="round">
        </div>
    </form>

        <!--fake submit-->
        <div id="fakeButt" 
        style="margin:0 auto;width: 100%;padding: 2vmax;
        background-color:#f5f5f6;font-size: 2vmax;color: #333;">
        <span class="round" style="cursor: not-allowed;padding: 0.5vmax;">
            You will be able to submit answer in Q: 4, 8, and 12.
            </span>
        </div>

        <div id='foot'>
            <span class="cursive" style="font-size:1.7vmax;text-align: center;color: #888;letter-spacing: 0.5vw;">
            CC2023</span>
            <img src="ccLogoDark.png" style="width:1.7vmax;text-align: center;display: inline;">
            <span class="cursive" style="font-size:1.7vmax;color: #888;letter-spacing: 0.1vw;">
                ElectroCardioGame
            </span><br>
            <span style="font-size:1.6vmax;color: #bbb;">
                <sup style="color:#bbb;">x</sup> heartRhythmBox.com</span>
        </div>
        
    </div>


    
    <!--fixed stuffs-->
        <!--orientation bar-->
        <div id="oBar">
            <i id="aRight" onclick="aRotate()" class="fa-regular fa-window-maximize" title="answer sheet to the right" 
            style="rotate:90deg;font-size: 2vmax;color: #888;cursor: pointer;padding: 0.2vmax;"></i>
            <i id="aBottom" onclick="aRotate()" 
            class="fa-regular fa-window-maximize fa-shake" title="answer sheet to the bottom" 
            style="font-size:2vmax;color: #888;cursor: pointer;rotate: 180deg;padding: 0.2vmax;
            --fa-animation-duration:2s;--fa-animation-iteration-count:5"></i>
        </div>
    
        <!--bouncy arrow down-->
        <i class="fa-solid fa-circle-chevron-down fa-bounce" 
        style='font-size: 3vmax;position: absolute;color:#efefef;
        text-shadow: #777 4px 4px 8px;' 
        id="aDown"></i>
    <!--end sticky bars-->
</div>
    
<!--top and foot-->

<!--intro page-->
<div id="card"> 
    <div class="lemon cursive" style="font-size:3vmax;text-align: center;padding-top: 10vh;">
    CC2023
    <br>
    <img src="ccLogoLemon.png" 
    style="width:3vmax;text-align: center;padding: 2vmax 0;animation:animateInvert 10s infinite">
    <br>ElectroCardioGame</div><br>
    <div id="welcome">
        Thanks for joining us.<br>
        Please wait here. The game will begin shortly.<br>
        If you enter the game in the middle of the question, please also wait here for the next question.
    </div>
    <div id="wait"></div>
    <div style="font-size:1.8vmax;color: #021c49">
    <sup style="color:#021c49;">X</sup> heartRhythmBox.com
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
window.onbeforeunload = (event) => {
  event.preventDefault();
  return event.returnValue = 'onbeforeunload';
};

//global var
var totalQ = 12
var qNo = -1;
var q2Vote = [4,8,12];
var score = 0;
var nameEntered = 'Anonymous';
var keyJson = [
            {"no":4, "key": '1.3', "score": 2},
            {"no":4, "key": '3.2', "score": 4},
            {"no":4, "key": '6.7', "score": 4},         
            {"no":8, "key": '1.6', "score": 4},
            {"no":8, "key": '2.2', "score": 4},  
            {"no":8, "key": '3.6', "score": 3},
            {"no":8, "key": '4.1', "score": 3},   
            {"no":12, "key": '1.1', "score": 2},
            {"no":12, "key": '2.2', "score": 4},
            {"no":12, "key": '3.7', "score": 4}
        ]
var submitted=false;
var supUrl;var supKey;
setUpSup()
//fetch supValue
function setUpSup(){
    fetch('/.netlify/functions/hello')
    .then(response => response.json())
    .then(result =>setUpVar(result))
    .catch(error => console.log('error', error));

    function setUpVar(data){
        supUrl = data[0];supKey = data[1]
        sub(supUrl,supKey)
    }

}

//subscribe
function sub(url,key){
    supUrl = url;supKey = key;
    const database = supabase.createClient(supUrl,supKey)
    //console.log (database)

    database
    .channel('public:qFeed')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'qFeed' }, payload => {
      //console.log('Change received!', payload)
      qNow = payload.new.questionNo
      //document.getElementById('demo').innerHTML = qNow;

      if (qNow>=1000){endGame()}
      if (qNow>100 && qNow<1000){
                if (!submitted) {handleSubmit()};
                afterSubmit();submitted=false;
            } 
      if (qNow<=12){
                qNo = qNow;
                ecgLoad();
                }
    })
    .subscribe()
}


//submit
function handleSubmit(){
    const database = supabase.createClient(supUrl,supKey)
    //console.log (database)

    //get data
    thisScore = calcScore();  
    score = score + thisScore;  
    if (qNo==4)
        {if (document.getElementById('audName').value!='')
            {nameEntered = document.getElementById('audName').value;}
            }
    
    //sending data
    const sendData = async () => {
    const feed = await database.from("Audience").insert({
        audName: nameEntered, oldName: nameEntered,
        qNo: qNo, score: score
    })
    //console.log(feed)
    }
  sendData();
  submitted=true;
  afterSubmit();
}
//end submit

function ecgLoad(){
    displayName();
    ecgPage = document.getElementById('ecgPage')
    ecgPage.style.maxHeight = 'none'
    ecgPage.style.overflow = 'inherit'
    document.getElementById('card').style.display = 'none'
    sButt = document.getElementById('submitBut')
    form = document.getElementById('audScore')
    aSheet = document.getElementById('answerSheet')
    fButt = document.getElementById ('fakeButt')
    foot = document.getElementById ('foot')
    fButt.style.display = 'none'
    ecgArea = document.getElementById('ecgArea')
    aSheet.scrollTop = 0
    oBar = document.getElementById('oBar')

    //clear answersheet
    var input = document.getElementsByClassName('cBx')
    for (let index = 0; index < input.length; index++) {
        input[index].checked = false;
    }

    var vote=0;
    for (let index = 0; index < q2Vote.length; index++) {
        if (qNo==q2Vote[index]){
            vote = 1;
        }
    }
    if (qNo==0)
        {aSheet.style.display = 'inline-block';
        form.style.display = 'none';
        fButt.style.display = 'inline-block'
        foot.style.display = 'inline-block'
        ecgArea.style.width = '75'
        arrow('on')
        oBar.style.display = 'block'
        }
    else if (vote==1){
        oBar.style.display = 'block'
        form.style.display = 'inline-block';
        sButt.style.display = 'inline-block'
        aSheet.style.display = 'inline-block'
        foot.style.display = 'inline-block'
        ecgArea.style.width = '75%'

        if (qNo>q2Vote[0]){
            document.getElementById('audName').style.display = 'none'
            document.getElementById('nameInput').innerHTML = 
            'Your Name is: '+ nameEntered 
        }
        }
        else {
            aSheet.style.display = 'none'
            form.style.display = 'none'
            ecgArea.style.width = '100%'
            arrow('off')
            oBar.style.display = 'none'
            foot.style.display = 'inline-block'
        }
   
}

function endGame(){
    document.getElementById('ecgPage').style.display = 'none'
    document.getElementById('ecg').style.display = 'none'
    document.getElementById('card').style.display = 'block'
    document.getElementById('welcome').innerHTML = '..BYE..'
    document.getElementById('wait').innerHTML = ''
}

function afterSubmit(){
    thisScore = calcScore();
    ecgPage = document.getElementById('ecgPage')
    ecgPage.style.maxHeight = '100vh'
    ecgPage.style.overflow = 'hidden'
    document.getElementById('card').style.display = 'block'
    //document.getElementById('answerSheet').style.display = 'none'
    //document.getElementById('foot').style.display = 'none'
    //document.getElementById('audScore').style.display = 'none'

    if (submitted){
        document.getElementById('welcome').innerHTML = nameEntered + ', thanks for joining the vote' + '<br />' + 
        'You got ' + thisScore + ' from this question.' + '<br />' +
        'Your total score is '+ score + '<br />' 
    }
    else {
        document.getElementById('welcome').innerHTML = ''
    }
    
    if (qNo==12){document.getElementById('wait').innerHTML 
    = 'That was the last question.' + '<br />' +
    'We hope you enjoyed/learned from us.' + '<br />' +
    'See you next year.'+'<br />'
    }
    else {
        (document.getElementById('wait').innerHTML = 'Please wait here for the next question.')
    }
}

function calcScore(){
    var input = document.getElementsByClassName('cBx')

    //get answer array
    const answer = []
    for (let index = 0; index < input.length; index++) {
        if (input[index].checked){
            const item = input[index].id
            answer.push(item)
        }
    }

    //get key and score
    const key = [];const kScore = []
    for (let index = 0; index < keyJson.length; index++) {
        if (keyJson[index].no==qNo){
            key.push(keyJson[index].key)
            kScore.push(keyJson[index].score)
        }
    }

    var thisScore = 0;var correctedItem = 0;
    answer.forEach(function(item){
        for (let index = 0; index < key.length; index++) {
            if (item == key[index]){
                thisScore = thisScore + (kScore[index])  
                correctedItem++;  
            } 
        }
    })
    //deduction
    if (answer.length>correctedItem){
        thisScore = thisScore - (answer.length-correctedItem)
    }
    //check for double checked in Q8
    if (qNo==8){
        if (input[5].checked && input[8].checked){
            thisScore = thisScore - 4
        }
    }

    //document.getElementById('demo').innerHTML = thisScore;
    return thisScore;
}

function displayName(){
    title = document.getElementById('title')
    ecg = document.getElementById('ecg')
    title.innerHTML = "Question No. " + qNo + " /" + totalQ;
    var source = "ecgs//ecg"+ qNo.toString()+".png";
    ecg.src = source;

    //fade in 0-100%
    for (let i=0;i<=100;i++){
        setTimeout(function(){
            let opac = i
            title.style.opacity = opac.toString() + '%'
            ecg.style.opacity = opac.toString() + '%'
        },9*i)
    }

    if (qNo<12){
    var plus = qNo+1
    var preLoadSource = "ecgs//ecg"+ plus.toString()+".png";
    document.getElementById('preLoad').src = preLoadSource}
}


//front-end add-on sticky stuff and oBar
//arrow down
function arrow(i){
    const aDn = document.getElementById('aDown')
    if (i=='on'){
        const sheet = document.getElementById('answerSheet')
        const rect = sheet.getBoundingClientRect()
        aDn.style.left = rect.left + ((rect.right - (rect.left))/2) + 'px'
        aDn.style.top = rect.bottom - (0.1*rect.height) + 'px'}
        aDn.style.display = 'block'
    
    if (i=='off'){
        aDn.style.display = 'none'
    }
    
}

var dirToggle = 'bottom'

function aRotate(){
    if (dirToggle=='right'){
        document.getElementById('ecgArea').style.width = '75%' 
        var sheet = document.getElementById('answerSheet')
        sheet.style.width = '25%'
        sheet.style.display = 'inline-block';
        sheet.style.direction = 'rtl'
        sheet.style.maxHeight = '92vh'
        sheet.style.overflowY = 'scroll'

        
        dirToggle = 'bottom'
        document.getElementById('aRight').style.display = 'none'
        document.getElementById('aBottom').style.display = 'inline-block'
    
    } else {
        arrow('off')
        document.getElementById('workSheet').style.flexWrap = 'wrap'
        document.getElementById('ecgArea').style.width = '100%'
        var sheet = document.getElementById('answerSheet')
        sheet.style.width = '100%'
        sheet.style.display = 'flex';
        //sheet.style.flexWrap = 'wrap'
        sheet.style.direction = 'ltr'
        sheet.style.maxHeight = 'fit-content'
        sheet.style.overflow = 'visible'

        //col
        column = document.getElementsByClassName('col')
        column[0].style.flex = '29%'
        column[1].style.flex = '29%'
        column[2].style.flex = '36%'

        dirToggle = 'right'
        document.getElementById('aRight').style.display = 'inline-block'
        document.getElementById('aBottom').style.display = 'none'
    }
}

</script>
</body>
</html>